

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Processing MT data on the NCI &mdash; NCI training 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> NCI training
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Processing MT data on the NCI</a><ul>
<li><a class="reference internal" href="#Requirements">Requirements</a></li>
<li><a class="reference internal" href="#Preparation">Preparation</a></li>
<li><a class="reference internal" href="#Putting-it-together">Putting it together</a><ul>
<li><a class="reference internal" href="#Running-on-the-NCI">Running on the NCI</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">NCI training</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Processing MT data on the NCI</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/_MT/MT_notebooks/MT_bulk_processing.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div><p><img alt="a191091f7d9b43b49bf3daaee03a0d2b" class="no-scaled-link" src="https://nci.org.au/sites/default/files/logos/Logo-NCI.svg" width="300" /></p>
</div><div class="section" id="Processing-MT-data-on-the-NCI">
<h1>Processing MT data on the NCI<a class="headerlink" href="#Processing-MT-data-on-the-NCI" title="Permalink to this headline">¶</a></h1>
<div class="section" id="Requirements">
<h2>Requirements<a class="headerlink" href="#Requirements" title="Permalink to this headline">¶</a></h2>
<p>The following tutorial shows how to process magnetotelluric (MT) data stored on the National Computational Infrastructure (NCI). As such it makes certain assumptions about the storage structure, mainly that the time series data are stored in separate folders for each site and separate folders for each day. The tutorial uses the <a class="reference external" href="https://www.whoi.edu/science/AOPE/people/achave/Site/Next1.html">Bounded Influence, Remote Reference Processing (BIRRP) code.</a></p>
</div>
<div class="section" id="Preparation">
<h2>Preparation<a class="headerlink" href="#Preparation" title="Permalink to this headline">¶</a></h2>
<p>For this example we will be processing the <a class="reference external" href="http://dx.doi.org/10.25914/5bea5867bb322">Renmark 2009 time series data</a> located on NCI’s /g/data file system. The first step in processing is to work out the starting and finishing dates for each site in the survey, in order to find the sites with overlapping time-series which can be used for remote-reference.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="k">def</span> <span class="nf">_linecount</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return number of lines in a file &quot;&quot;&quot;</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">num_lines</span>

<span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return information about each site &quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sites</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))]</span>

    <span class="n">sites</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span>
                       <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">last_files</span> <span class="o">=</span> <span class="n">files</span>
            <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span>
                                                        <span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
                <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">])</span>
        <span class="c1">#if not files:</span>
        <span class="c1">#    continue</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">last_files</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">_linecount</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">length</span><span class="o">/</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">-</span>
                                  <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">seconds</span> <span class="o">*</span> <span class="n">frequency</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sites</span>

</pre></div>
</div>
</div>
<p>This function will read in the metadata required for processing a survey. After this processing it will write out this metadata into a file, which will be read back in the next time that the metadata is required.</p>
<p>We will also make a function to calculate the overlap between two sites:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate time overlap of a local site and remote site &quot;&quot;&quot;</span>
    <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">],</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span>
    <span class="n">int_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">],</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span>
</pre></div>
</div>
</div>
<p>If the overlap is less than 5 hours then the function returns nothing, indicating no substantial overlap, otherwise it will return the start and end times of the intersection.</p>
<p>The next stage is to make functions for writing out the overlap between the time series from two different sites as ASCII files for BIRRP use as inputs. Here one of the sites is designated as the remote reference.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>

<span class="k">def</span> <span class="nf">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read in a time series, apply a decimation and write out &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_fn</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_fn</span><span class="p">):</span>
         <span class="k">return</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;decimating </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">new_fn</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">num_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write files &quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;local.&#39;</span> <span class="o">+</span> <span class="n">channel</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">remote</span> <span class="k">else</span> <span class="s1">&#39;remote.&#39;</span> <span class="o">+</span> <span class="n">channel</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">tstart</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fn</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">)):</span>
        <span class="k">return</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">)))</span>
    <span class="n">ofile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">num_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_skip</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># print(&#39;did not extract from {}&#39;.format(files))</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">write_birrp_inputs</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write out the intersection of two files &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">):</span>
        <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span> <span class="o">=</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">)</span>
    <span class="n">local_skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_start</span> <span class="o">-</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span>
    <span class="n">remote_skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_start</span> <span class="o">-</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span>
    <span class="n">local_skip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_skip</span><span class="p">)</span>
    <span class="n">remote_skip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">remote_skip</span><span class="p">)</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
        <span class="n">remote_skip</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">num_samples</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">dec_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;undecimated&#39;</span><span class="p">)</span>
    <span class="n">dec10_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">)</span>
    <span class="n">dec100_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec10_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec100_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BX&#39;</span><span class="p">,</span> <span class="s1">&#39;BY&#39;</span><span class="p">,</span> <span class="s1">&#39;EX&#39;</span><span class="p">,</span> <span class="s1">&#39;EY&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">local_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dec_dir</span><span class="p">,</span> <span class="n">int_start</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="s1">&#39;B&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">remote_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dec_dir</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span>
                    <span class="n">remote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">):</span>
            <span class="n">bn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">new_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec10_dir</span><span class="p">,</span> <span class="n">bn</span><span class="p">)</span>
            <span class="n">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">new_fn</span>
            <span class="n">new_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec100_dir</span><span class="p">,</span> <span class="n">bn</span><span class="p">)</span>
            <span class="n">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">int_start</span>

</pre></div>
</div>
</div>
<p>Note that decimations are also performed, with the decimated time series placed into new folders. By decimating the data we can achieve responses for longer periods than would otherwise be possible. Decimation is made using <a class="reference external" href="https://docs.scipy.org/doc/scipy-1.1.0/reference/generated/scipy.signal.decimate.html">scipy.signal.decimate</a>, which applies an anti-aliasing filter before decimating.</p>
<p>For each three of these folders we generate a BIRRP script:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">gen_birrp_script</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span> <span class="n">tstart</span><span class="p">):</span>
    <span class="n">birrp_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;65536,2,13&#39;</span><span class="p">,</span> <span class="s1">&#39;3,1,3&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0,0.0003,0.9999&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0&#39;</span><span class="p">,</span> <span class="s1">&#39;0.003,10000&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_local.EY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_local.EX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_local.BY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_local.BX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_remote.BY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_remote.BX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0,90,0&#39;</span><span class="p">,</span> <span class="s1">&#39;0,90,0&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0,90,0&#39;</span><span class="p">])</span>
    <span class="n">birrp_string</span> <span class="o">=</span> <span class="n">birrp_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                       <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span>
                                       <span class="n">tstart</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">birrp_string</span>
</pre></div>
</div>
</div>
<p>The BIRRP script has many different parameters and the best parameters will depend on the dataset. For more information see the <a class="reference external" href="http://www.whoi.edu/science/AOPE/people/achave/Site/Next1_files/birrp.5.pdf">BIRRP manual</a>.</p>
<p>We also need a script to run BIRRP and to clean up the output files:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">run_birrp</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">birrp_script</span><span class="p">,</span> <span class="n">birrp_location</span><span class="p">):</span>
    <span class="n">script_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;script.txt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">birrp_script</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.j&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)):</span>
        <span class="k">return</span>
    <span class="c1">#os.system(&#39;mpirun -np 32 {} &lt; {}&#39;.format(birrp_location, script_fn)) ### Use if using the mpi modified version of BIRRP</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &lt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">birrp_location</span><span class="p">,</span> <span class="n">script_fn</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;fft.*&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;remote.*&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;local.*&#39;</span><span class="p">):</span>  <span class="c1">### comment this for loop if you want to keep the intermediate files</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Finally, we would like a script to convert the outputs from our three frequency ranges into edi-files and to merge them into a single file. The merging should take place at the longest overlapping period, as this introduces the minimum amount of error resulting from aliasing during the decimation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">mtpy.core.edi</span>
<span class="kn">from</span> <span class="nn">mtpy.uofa.qel_monitoring_j2edi</span> <span class="kn">import</span> <span class="n">convert2edi</span>
<span class="kn">from</span> <span class="nn">mtpy.uofa.simpleplotEDI</span> <span class="kn">import</span> <span class="n">plotedi</span>


<span class="k">def</span> <span class="nf">process_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span> <span class="n">instr_resp_fn</span><span class="p">):</span>
    <span class="n">edi</span><span class="p">,</span> <span class="n">coh</span> <span class="o">=</span> <span class="n">convert2edi</span><span class="p">(</span><span class="n">site_name</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="p">,</span> <span class="n">instr_resp_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span>  <span class="n">mtpy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">configfile</span><span class="o">.</span><span class="n">read_survey_configfile</span><span class="p">(</span><span class="n">survey_cfg_fn</span><span class="p">)[</span><span class="n">site_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;loc&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;acqdate&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;acquired_by&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqby&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;acquired_by&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqby&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">edi</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">writefile</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">allow_overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">edi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;qel&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">edi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">edi</span><span class="p">)</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="n">edi_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">new_edi_name</span> <span class="o">=</span> <span class="n">new_name</span> <span class="o">+</span> <span class="s1">&#39;.edi&#39;</span>
    <span class="n">new_coh_name</span> <span class="o">=</span> <span class="n">new_name</span> <span class="o">+</span> <span class="s1">&#39;.coh&#39;</span>
    <span class="n">new_edi</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">new_edi_name</span>
    <span class="n">coh_orig</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">coh</span>
    <span class="n">new_coh</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">new_coh_name</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">new_edi</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">coh_orig</span><span class="p">,</span> <span class="n">new_coh</span><span class="p">)</span>
    <span class="c1"># edi = glob(os.path.join(out_dir, &#39;*.edi&#39;))[0]</span>
    <span class="n">plotedi</span><span class="p">(</span><span class="n">new_edi</span><span class="p">,</span> <span class="n">saveplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">merge_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">site_name</span><span class="p">):</span>
    <span class="n">edi_fns</span> <span class="o">=</span> <span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;undecimated&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">))</span> <span class="o">+</span>
               <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">))</span> <span class="o">+</span>
               <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">)))</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">out_small</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">combine_edifiles</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edi_fns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_fn</span><span class="o">=</span><span class="n">out_small</span><span class="p">,</span>
                                   <span class="n">merge_freq</span><span class="o">=</span><span class="n">e1</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">out_large</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">site_name</span><span class="p">)</span>
    <span class="n">in_small</span> <span class="o">=</span> <span class="n">out_small</span> <span class="o">+</span> <span class="s1">&#39;_merged.edi&#39;</span>
    <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">combine_edifiles</span><span class="p">(</span><span class="n">in_small</span><span class="p">,</span> <span class="n">edi_fns</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out_fn</span><span class="o">=</span><span class="n">out_large</span><span class="p">,</span>
                                   <span class="n">merge_freq</span><span class="o">=</span><span class="n">e2</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">in_small</span><span class="p">)</span>
    <span class="n">final_fn</span> <span class="o">=</span> <span class="n">out_large</span> <span class="o">+</span> <span class="s1">&#39;_merged.edi&#39;</span>
    <span class="n">plotedi</span><span class="p">(</span><span class="n">final_fn</span><span class="p">,</span> <span class="n">saveplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Each EDI generated is also plotted. This code makes use of the <code class="docutils literal notranslate"><span class="pre">mtpy</span></code> <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0098300414001794">(Krieger and Peacock, 2014)</a> library.</p>
<p>Note that this script requires both a instrument response function file, and a survey configuration filename. Details on the survey configuration file can be found in the <code class="docutils literal notranslate"><span class="pre">mtpy</span></code> package, however it will looks something like this:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="p">[</span><span class="n">RM0105</span><span class="p">]</span>
<span class="n">station_type</span> <span class="o">=</span> <span class="n">mt</span>
<span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">34.05543333333333</span>
<span class="n">lon</span> <span class="o">=</span> <span class="mf">140.62353333333334</span>
<span class="n">elev</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sampling</span> <span class="o">=</span> <span class="mf">0.002</span>
<span class="n">loc</span> <span class="o">=</span> <span class="n">Renmark</span>
<span class="n">acqdate</span> <span class="o">=</span> <span class="mi">2009</span>
<span class="n">acquired_by</span> <span class="o">=</span> <span class="n">The_University_of_Adelaide</span>


<span class="p">[</span><span class="n">RM0106</span><span class="p">]</span>
<span class="n">station_type</span> <span class="o">=</span> <span class="n">mt</span>
<span class="n">lat</span> <span class="o">=</span> <span class="o">-</span><span class="mf">34.041183333333336</span>
<span class="n">lon</span> <span class="o">=</span> <span class="mf">140.60265</span>
<span class="n">elev</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">sampling</span> <span class="o">=</span> <span class="mf">0.002</span>
<span class="n">loc</span> <span class="o">=</span> <span class="n">Renmark</span>
<span class="n">acqdate</span> <span class="o">=</span> <span class="mi">2009</span>
<span class="n">acquired_by</span> <span class="o">=</span> <span class="n">The_University_of_Adelaide</span>

<span class="c1">#[RM0107]</span>
<span class="c1">#station_type = mt</span>
<span class="c1">#lat = -34.004266666666666</span>
<span class="c1">#lon = 140.5869</span>
<span class="c1">#elev = 0</span>
<span class="c1">#sampling = 0.002</span>
<span class="c1">#loc = Renmark</span>
<span class="c1">#acqdate = 2009</span>
<span class="c1">#acquired_by = The_University_of_Adelaide</span>
</pre></div>
</div>
</div>
<p>And so on, for each site.</p>
</div>
<div class="section" id="Putting-it-together">
<h2>Putting it together<a class="headerlink" href="#Putting-it-together" title="Permalink to this headline">¶</a></h2>
<p>These functions can be wrapped into one function to process a single site with a single remote site:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">run_one_site</span><span class="p">(</span><span class="n">local_name</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;undecimated&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">],</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got metadata&#39;</span><span class="p">)</span>
    <span class="n">local_site</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">local_name</span><span class="p">]</span>
    <span class="n">remote_site</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">remote_name</span><span class="p">]</span>
    <span class="n">dir_name</span> <span class="o">=</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">samples</span><span class="p">,</span> <span class="n">tstart</span> <span class="o">=</span> <span class="n">write_birrp_inputs</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;written inputs&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">dirs</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span>
        <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
        <span class="n">birrp_script</span> <span class="o">=</span> <span class="n">gen_birrp_script</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span>
                                        <span class="n">local_name</span><span class="p">,</span> <span class="n">tstart</span><span class="p">)</span>
        <span class="n">run_birrp</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">birrp_script</span><span class="p">,</span> <span class="n">birrp_location</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ran birrp&#39;</span><span class="p">)</span>
        <span class="n">process_birrp_results</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;survey_cfg_fn&#39;</span><span class="p">],</span>
                              <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instr_resp_fn&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processed results&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
    <span class="n">merge_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">local_name</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>If we save all of this to a file as <code class="docutils literal notranslate"><span class="pre">nci_birrp.py</span></code> we can create a separate file in the same folder which calls it and runs one site:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python2.7</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">nci_birrp</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/States_and_Territories/SA/Broadband/Renmark_2009/TS&#39;</span>
    <span class="n">birrp_location</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_processing_test/birrp/birrp&#39;</span> <span class="c1">### This version of BIRRP was compiled specifically for the Renmark 2009 use case</span>
    <span class="n">survey_cfg_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/survey_config/renmark.cfg&#39;</span>
    <span class="n">instr_resp_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/instrument_response_function/lemi_coils_instrument_response_freq_real_imag.txt&#39;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instr_resp_fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instr_resp_fn</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;survey_cfg_fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey_cfg_fn</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;birrp_location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">birrp_location</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_dir</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">run_one_site</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can save this as <code class="docutils literal notranslate"><span class="pre">proc_site.py</span></code>.</p>
<p>Here we enter the parameters specific to our example. For our example we use the Renmark 2009 MT dataset from the NCI, which is recorded at 500 Hz and has a configuration file located at <code class="docutils literal notranslate"><span class="pre">/g/data/up99/sandbox/bulk_birrp_processing_test/survey_config/renmark.cfg</span></code>.</p>
<p>The system arguments are site specific, with the local site name, remote site name, and temporary working directory.</p>
<div class="section" id="Running-on-the-NCI">
<h3>Running on the NCI<a class="headerlink" href="#Running-on-the-NCI" title="Permalink to this headline">¶</a></h3>
<p>We are now almost ready to process the entire survey on the NCI. First we will need a script to submit <code class="docutils literal notranslate"><span class="pre">proc_site.py</span></code> to process the data from one site with a single remote site.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">add_shell_run</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">):</span>
    <span class="n">python_call</span> <span class="o">=</span> <span class="n">proc_site</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="n">shell_script</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;#!/bin/bash&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;#PBS -P up99&#39;</span><span class="p">,</span> <span class="s1">&#39;#PBS -q normal&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;#PBS -l walltime=3:00:00,mem=64GB,ncpus=24,jobfs=30GB&#39;</span><span class="p">,</span><span class="s1">&#39;#PBS -l storage=gdata/my80+gdata/up99&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;#PBS -l wd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;module load python2/2.7.17&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module load intel-compiler/2020.2.254&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module use /g/data/up99/modulefiles/&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module load mtpy_2013/mtpy_0.0.1&#39;</span><span class="p">,</span><span class="s1">&#39;module load openmpi/4.0.2&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">python_call</span><span class="p">])</span>
    <span class="n">shell_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">local_site</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">remote_site</span> <span class="o">+</span> <span class="s1">&#39;.sh&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shell_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shell_script</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;qsub </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shell_fn</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>This function will submit the job to the NCI. Take care to choose optimal values for the walltime and memory consumption, as these will change depending on the recording length. Our example PBS script is using project up99 (change this to a compute project code that you are a member of), the normal queue, a walltime of 3 hours, 24 CPUs and 64 GB of memory. Please see <a class="reference external" href="https://opus.nci.org.au/display/Help/PBS+Directives+Explained">PBS directives explained</a> for more information on the PBS
flags.</p>
<p>We can now loop over each combination of local and remote sites, check to see if there is sufficient overlap, and if so, submit a job to the NCI to process.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">mtpy.utils.configfile</span>

<span class="k">def</span> <span class="nf">loop_sites</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">survey_cfg_fn</span><span class="p">:</span>
        <span class="n">survey_cfg</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">configfile</span><span class="o">.</span><span class="n">read_survey_configfile</span><span class="p">(</span><span class="n">survey_cfg_fn</span><span class="p">)</span>
    <span class="n">site_names</span> <span class="o">=</span> <span class="n">sites</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">site_names</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">survey_cfg</span><span class="p">:</span>
            <span class="n">sites</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">local_site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">remote_site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">local_site</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="n">remote_site</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;add </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">))</span>
                <span class="n">add_shell_run</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
                <span class="c1">#sys.exit()  ####uncomment this line if you are troubleshooting</span>

</pre></div>
</div>
</div>
<p>An option is also included to pass a survey configuration file (as detailed above), where you can comment out any sites which you do not want to process.</p>
<p>Let’s write our <code class="docutils literal notranslate"><span class="pre">nci_birrp.py</span></code> and <code class="docutils literal notranslate"><span class="pre">proc_site.py</span></code> files to our local working directory on Gadi:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%writefile</span> nci_birrp.py

<span class="c1"># module load birrp</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">mtpy.core.edi</span>
<span class="kn">from</span> <span class="nn">mtpy.uofa.qel_monitoring_j2edi</span> <span class="kn">import</span> <span class="n">convert2edi</span>
<span class="kn">from</span> <span class="nn">mtpy.uofa.simpleplotEDI</span> <span class="kn">import</span> <span class="n">plotedi</span>
<span class="kn">import</span> <span class="nn">mtpy.utils.configfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="c1">#######################################################################</span>
<span class="c1">#                                                                     #</span>
<span class="c1"># Note that you will have to change the following variables to match  #</span>
<span class="c1"># the time series data location, birrp executable location, survey    #</span>
<span class="c1"># config file, instrument response function, temporary directory,     #</span>
<span class="c1"># recorded frequency and and proc_site.py file you are using          #</span>
<span class="c1">#                                                                     #</span>
<span class="c1">#######################################################################</span>

<span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/States_and_Territories/SA/Broadband/Renmark_2009/TS&#39;</span>
<span class="n">birrp_location</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/birrp/birrp&#39;</span> <span class="c1">### BIRRP compiled for this Renmark 2009 use case</span>
<span class="n">survey_cfg_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/survey_config/renmark.cfg&#39;</span>
<span class="n">instr_resp_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/instrument_response_function/lemi_coils_instrument_response_freq_real_imag.txt&#39;</span>
<span class="n">tmp_dir</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/processing_directory/&#39;</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">proc_site</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/processing_directory/proc_site.py </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span>

<span class="k">def</span> <span class="nf">_linecount</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return number of lines in a file &quot;&quot;&quot;</span>
    <span class="n">num_lines</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="mi">1</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">num_lines</span>


<span class="k">def</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return information about each site &quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s1">&#39;metadata.json&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">sites</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sites</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))]</span>

    <span class="n">sites</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">i</span><span class="p">,</span> <span class="p">{})</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">sites</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">site</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">days</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span>
                       <span class="n">i</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">day</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">days</span><span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">last_files</span> <span class="o">=</span> <span class="n">files</span>
            <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span>
                                                        <span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
                <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
            <span class="k">continue</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">k</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;files&#39;</span><span class="p">])</span>
        <span class="c1">#if not files:</span>
        <span class="c1">#    continue</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">last_files</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">end_date</span><span class="p">,</span> <span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="n">_linecount</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">end_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">length</span><span class="o">/</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;samples&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;end_time&#39;</span><span class="p">]</span> <span class="o">-</span>
                                  <span class="n">sites</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">seconds</span> <span class="o">*</span> <span class="n">frequency</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sites</span>


<span class="k">def</span> <span class="nf">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculate time overlap of a local site and remote site &quot;&quot;&quot;</span>
    <span class="n">int_start</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">],</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span>
    <span class="n">int_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">],</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">/</span><span class="mi">60</span><span class="o">/</span><span class="mi">60</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span>


<span class="k">def</span> <span class="nf">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Read in a time series, apply a decimation and write out &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_fn</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">new_fn</span><span class="p">):</span>
         <span class="k">return</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;decimating </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fn</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">decimate</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">decimation</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">new_fn</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">num_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">remote</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write files &quot;&quot;&quot;</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="s1">&#39;local.&#39;</span> <span class="o">+</span> <span class="n">channel</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">remote</span> <span class="k">else</span> <span class="s1">&#39;remote.&#39;</span> <span class="o">+</span> <span class="n">channel</span>
    <span class="n">fn</span> <span class="o">=</span> <span class="n">tstart</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">fn</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">)):</span>
        <span class="k">return</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;writing to </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">)))</span>
    <span class="n">ofile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">num_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_skip</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">next</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ifile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ifile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>
                <span class="c1"># print(&#39;did not extract from {}&#39;.format(files))</span>
        <span class="n">ofile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>



<span class="k">def</span> <span class="nf">write_birrp_inputs</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Write out the intersection of two files &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">):</span>
        <span class="n">int_start</span><span class="p">,</span> <span class="n">int_end</span> <span class="o">=</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">)</span>
    <span class="n">local_skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_start</span> <span class="o">-</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span>
    <span class="n">remote_skip</span> <span class="o">=</span> <span class="p">(</span><span class="n">int_start</span> <span class="o">-</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span>
    <span class="n">local_skip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">local_skip</span><span class="p">)</span>
    <span class="n">remote_skip</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">remote_skip</span><span class="p">)</span>
    <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">int_end</span> <span class="o">-</span> <span class="n">int_start</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">*</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
        <span class="n">remote_skip</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">num_samples</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="n">dec_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;undecimated&#39;</span><span class="p">)</span>
    <span class="n">dec10_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">)</span>
    <span class="n">dec100_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec10_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dec100_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">channels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BX&#39;</span><span class="p">,</span> <span class="s1">&#39;BY&#39;</span><span class="p">,</span> <span class="s1">&#39;EX&#39;</span><span class="p">,</span> <span class="s1">&#39;EY&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">channels</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">local_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dec_dir</span><span class="p">,</span> <span class="n">int_start</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">channels</span> <span class="k">if</span> <span class="s1">&#39;B&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;files&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
        <span class="n">write_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">remote_skip</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">dec_dir</span><span class="p">,</span> <span class="n">int_start</span><span class="p">,</span>
                    <span class="n">remote</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec_dir</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">):</span>
            <span class="n">bn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
            <span class="n">new_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec10_dir</span><span class="p">,</span> <span class="n">bn</span><span class="p">)</span>
            <span class="n">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">new_fn</span>
            <span class="n">new_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dec100_dir</span><span class="p">,</span> <span class="n">bn</span><span class="p">)</span>
            <span class="n">decimate_file</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">new_fn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">num_samples</span><span class="p">,</span> <span class="n">int_start</span>


<span class="k">def</span> <span class="nf">gen_birrp_script</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span> <span class="n">tstart</span><span class="p">):</span>
    <span class="n">birrp_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;65536,2,13&#39;</span><span class="p">,</span> <span class="s1">&#39;3,1,3&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0,0.0003,0.9999&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0&#39;</span><span class="p">,</span> <span class="s1">&#39;0.003,10000&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{3}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="s1">&#39;10&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{1}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_local.EY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_local.EX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_local.BY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_local.BX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_remote.BY&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{4}</span><span class="s1">_remote.BX&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0,90,0&#39;</span><span class="p">,</span> <span class="s1">&#39;0,90,0&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;0,90,0&#39;</span><span class="p">])</span>
    <span class="n">birrp_string</span> <span class="o">=</span> <span class="n">birrp_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                                       <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span>
                                       <span class="n">tstart</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">birrp_string</span>

<span class="k">def</span> <span class="nf">run_birrp</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">birrp_script</span><span class="p">,</span> <span class="n">birrp_location</span><span class="p">):</span>
    <span class="n">script_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;script.txt&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">script_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">birrp_script</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.j&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)):</span>
        <span class="k">return</span>
    <span class="c1">#os.system(&#39;mpirun -np 32 {} &lt; {}&#39;.format(birrp_location, script_fn)) ### Uncomment if using the mpi modified version of BIRRP</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> &lt; </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">birrp_location</span><span class="p">,</span> <span class="n">script_fn</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="s1">&#39;fft.*&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1">#for f in glob(&#39;remote.*&#39;) + glob(&#39;local.*&#39;):  ###uncomment this for loop if you want to remove the intermediate files</span>
    <span class="c1">#    #os.remove(f)</span>


<span class="k">def</span> <span class="nf">process_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="p">,</span> <span class="n">site_name</span><span class="p">,</span> <span class="n">instr_resp_fn</span><span class="p">):</span>
    <span class="n">edi</span><span class="p">,</span> <span class="n">coh</span> <span class="o">=</span> <span class="n">convert2edi</span><span class="p">(</span><span class="n">site_name</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="p">,</span> <span class="n">instr_resp_fn</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">metadata</span> <span class="o">=</span>  <span class="n">mtpy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">configfile</span><span class="o">.</span><span class="n">read_survey_configfile</span><span class="p">(</span><span class="n">survey_cfg_fn</span><span class="p">)[</span><span class="n">site_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;loc&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;acqdate&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;acquired_by&#39;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqby&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;acquired_by&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="s1">&#39;acqby&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">edi</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">writefile</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">allow_overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">edi</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;qel&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">edi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">edi</span><span class="p">)</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="n">edi_file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">new_edi_name</span> <span class="o">=</span> <span class="n">new_name</span> <span class="o">+</span> <span class="s1">&#39;.edi&#39;</span>
    <span class="n">new_coh_name</span> <span class="o">=</span> <span class="n">new_name</span> <span class="o">+</span> <span class="s1">&#39;.coh&#39;</span>
    <span class="n">new_edi</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">new_edi_name</span>
    <span class="n">coh_orig</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">coh</span>
    <span class="n">new_coh</span> <span class="o">=</span> <span class="n">path</span> <span class="o">+</span> <span class="n">new_coh_name</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">edi</span><span class="p">,</span> <span class="n">new_edi</span><span class="p">)</span>
    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">coh_orig</span><span class="p">,</span> <span class="n">new_coh</span><span class="p">)</span>
    <span class="c1"># edi = glob(os.path.join(out_dir, &#39;*.edi&#39;))[0]</span>
    <span class="n">plotedi</span><span class="p">(</span><span class="n">new_edi</span><span class="p">,</span> <span class="n">saveplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span>

<span class="k">def</span> <span class="nf">merge_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">site_name</span><span class="p">):</span>
    <span class="n">edi_fns</span> <span class="o">=</span> <span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;undecimated&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">))</span> <span class="o">+</span>
               <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">))</span> <span class="o">+</span>
               <span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">,</span> <span class="s1">&#39;*edi&#39;</span><span class="p">)))</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">Edi</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">out_small</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;small&#39;</span><span class="p">)</span>
    <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">combine_edifiles</span><span class="p">(</span><span class="n">edi_fns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">edi_fns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out_fn</span><span class="o">=</span><span class="n">out_small</span><span class="p">,</span>
                                   <span class="n">merge_freq</span><span class="o">=</span><span class="n">e1</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">out_large</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">site_name</span><span class="p">)</span>
    <span class="n">in_small</span> <span class="o">=</span> <span class="n">out_small</span> <span class="o">+</span> <span class="s1">&#39;_merged.edi&#39;</span>
    <span class="n">mtpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">edi</span><span class="o">.</span><span class="n">combine_edifiles</span><span class="p">(</span><span class="n">in_small</span><span class="p">,</span> <span class="n">edi_fns</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out_fn</span><span class="o">=</span><span class="n">out_large</span><span class="p">,</span>
                                   <span class="n">merge_freq</span><span class="o">=</span><span class="n">e2</span><span class="o">.</span><span class="n">freq</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">in_small</span><span class="p">)</span>
    <span class="n">final_fn</span> <span class="o">=</span> <span class="n">out_large</span> <span class="o">+</span> <span class="s1">&#39;_merged.edi&#39;</span>
    <span class="n">plotedi</span><span class="p">(</span><span class="n">final_fn</span><span class="p">,</span> <span class="n">saveplot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_one_site</span><span class="p">(</span><span class="n">local_name</span><span class="p">,</span> <span class="n">remote_name</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">dirs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;undecimated&#39;</span><span class="p">:</span> <span class="mf">0.002</span><span class="p">,</span> <span class="s1">&#39;decimated10&#39;</span><span class="p">:</span> <span class="mf">0.02</span><span class="p">,</span> <span class="s1">&#39;decimated100&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">],</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;got metadata&#39;</span><span class="p">)</span>
    <span class="n">local_site</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">local_name</span><span class="p">]</span>
    <span class="n">remote_site</span> <span class="o">=</span> <span class="n">sites</span><span class="p">[</span><span class="n">remote_name</span><span class="p">]</span>
    <span class="n">dir_name</span> <span class="o">=</span> <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">remote_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
    <span class="n">samples</span><span class="p">,</span> <span class="n">tstart</span> <span class="o">=</span> <span class="n">write_birrp_inputs</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;written inputs&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dir_name</span> <span class="ow">in</span> <span class="n">dirs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sample_rate</span> <span class="o">=</span> <span class="n">dirs</span><span class="p">[</span><span class="n">dir_name</span><span class="p">]</span>
        <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dir_name</span><span class="p">)</span>
        <span class="n">birrp_script</span> <span class="o">=</span> <span class="n">gen_birrp_script</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">sample_rate</span><span class="p">,</span>
                                        <span class="n">local_name</span><span class="p">,</span> <span class="n">tstart</span><span class="p">)</span>
        <span class="n">run_birrp</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">birrp_script</span><span class="p">,</span> <span class="n">birrp_location</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ran birrp&#39;</span><span class="p">)</span>
        <span class="n">process_birrp_results</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;survey_cfg_fn&#39;</span><span class="p">],</span>
                              <span class="n">local_site</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instr_resp_fn&#39;</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processed results&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
    <span class="n">merge_birrp_results</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">local_name</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">add_shell_run</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">):</span>
    <span class="n">python_call</span> <span class="o">=</span> <span class="n">proc_site</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="n">shell_script</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;#!/bin/bash&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;#PBS -P up99&#39;</span><span class="p">,</span> <span class="s1">&#39;#PBS -q normal&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;#PBS -l walltime=3:00:00,mem=64GB,ncpus=24,jobfs=30GB&#39;</span><span class="p">,</span><span class="s1">&#39;#PBS -l storage=gdata/my80+gdata/up99&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;#PBS -l wd&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;module load python2/2.7.17&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module load intel-compiler/2020.2.254&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module use /g/data/up99/modulefiles/&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;module load mtpy_2013/mtpy_0.0.1&#39;</span><span class="p">,</span><span class="s1">&#39;module load openmpi/4.0.2&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">python_call</span><span class="p">])</span>
    <span class="n">shell_fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">local_site</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">remote_site</span> <span class="o">+</span> <span class="s1">&#39;.sh&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shell_fn</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">shell_script</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;qsub </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shell_fn</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">loop_sites</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">get_metadata</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">survey_cfg_fn</span><span class="p">:</span>
        <span class="n">survey_cfg</span> <span class="o">=</span> <span class="n">mtpy</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">configfile</span><span class="o">.</span><span class="n">read_survey_configfile</span><span class="p">(</span><span class="n">survey_cfg_fn</span><span class="p">)</span>
    <span class="n">site_names</span> <span class="o">=</span> <span class="n">sites</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">site_names</span><span class="p">:</span>
       <span class="k">if</span> <span class="n">site</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">survey_cfg</span><span class="p">:</span>
            <span class="n">sites</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">local_site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">remote_site</span> <span class="ow">in</span> <span class="n">sites</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">calc_intersection</span><span class="p">(</span><span class="n">sites</span><span class="p">[</span><span class="n">local_site</span><span class="p">],</span> <span class="n">sites</span><span class="p">[</span><span class="n">remote_site</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;add </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">))</span>
                <span class="n">add_shell_run</span><span class="p">(</span><span class="n">local_site</span><span class="p">,</span> <span class="n">remote_site</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">)</span>
                <span class="c1">#sys.exit()  ####uncomment line if you are troubleshooting</span>


</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%%writefile</span> proc_site.py

<span class="c1">#!/usr/bin/env python2.7</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">nci_birrp</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/States_and_Territories/SA/Broadband/Renmark_2009/TS&#39;</span>
    <span class="n">birrp_location</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/birrp/birrp&#39;</span>
    <span class="n">survey_cfg_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/survey_config/renmark.cfg&#39;</span>
    <span class="n">instr_resp_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/instrument_response_function/lemi_coils_instrument_response_freq_real_imag.txt&#39;</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;instr_resp_fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">instr_resp_fn</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;survey_cfg_fn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">survey_cfg_fn</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;birrp_location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">birrp_location</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_dir</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span>
    <span class="n">run_one_site</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

</pre></div>
</div>
</div>
<p>Note that for our example, we are using a BIRRP version compiled specifically for the Renmark 2009 use case (located in <code class="docutils literal notranslate"><span class="pre">/g/data/up99/sandbox/bulk_birrp_processing_test/birrp/birrp</span></code>). There is also an MPI parallelised version of BIRRP that can be used (located in <code class="docutils literal notranslate"><span class="pre">/g/data/up99/sandbox/bulk_birrp_processing_test/birrp_mpi</span></code>) - this version runs much faster on the undecimated data, but was not compiled to work with the decimated100 dataset.</p>
<p>Now let’s log onto Gadi and change into our working directory where the <code class="docutils literal notranslate"><span class="pre">nci_birrp.py</span></code> and <code class="docutils literal notranslate"><span class="pre">proc_site.py</span></code> files are located. Next we need to run the following commands to set up our local environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ module purge

$ module load pbs

$ module load python2/2.7.17

$ module use /g/data/up99/modulefiles

$ module load mtpy_2013/mtpy_0.0.1

$ module load openmpi/4.0.2
</pre></div>
</div>
<p>To process the entire Renmark MT survey we would need, for example, to open up an IPython terminal and execute the following commands:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">run</span> nci_birrp.py

<span class="n">base_dir</span> <span class="o">=</span> <span class="s1">&#39;/g/data/my80/States_and_Territories/SA/Broadband/Renmark_2009/TS/&#39;</span>
<span class="n">birrp_location</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/birrp/birrp&#39;</span>
<span class="n">survey_cfg_fn</span> <span class="o">=</span> <span class="s1">&#39;/g/data/up99/sandbox/bulk_birrp_processing_test/survey_config/renmark.cfg&#39;</span>
<span class="n">loop_sites</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">,</span> <span class="n">survey_cfg_fn</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can view the progress of the jobs in their queue by running <code class="docutils literal notranslate"><span class="pre">qstat</span> <span class="pre">-x</span></code> in a bash terminal:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre>
<span></span>%%bash
qstat -x
</pre></div>
</div>
</div>
<p>After the jobs have executed on the NCI, the processed EDIs and plots would be found in your tmp_dir, which for this example was <code class="docutils literal notranslate"><span class="pre">/g/data/up99/sandbox/bulk_birrp_processing_test/processing_directory/</span></code>.</p>
<p>If the processing fails, the cause can be debugged using the error file created when running the job. These are located in the same directory as the jobs are submitted (in our case the directory in which this script is run).</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018, NCI

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>